# Project Analysis Protocol (Mode 4/5)

> **기존 프로젝트에 Claude Skills Framework 적용**
> "프로젝트 분석해줘", "스킬 프레임워크 적용해줘"

---

## 트리거

```
기존 코드 존재 + 다음 중 하나:
- "프로젝트 분석해줘"
- "코드 분석해서 PRD 만들어줘"
- "스킬 프레임워크 적용해줘"
- "이 프로젝트 문서화해줘"
- "PRD 검증해줘"
```

---

## Phase 0: 기존 문서 확인 (신규)

### 0.1 문서 존재 여부 스캔
```
스캔 대상:
├── PRD.md          → 있음/없음
├── CLAUDE.md       → 있음/없음
├── README.md       → 있음/없음
└── .claude/        → 있음/없음
    ├── skills/     → 스킬 존재 여부
    ├── hooks/      → Hook 설정 여부
    └── settings.json
```

### 0.2 분기 처리

```
┌─────────────────────────────────────────────────────────┐
│ Case A: 문서 없음 (PRD ❌, CLAUDE.md ❌)                 │
│ → Mode 4: 완전 역분석                                   │
│ → Phase 1부터 진행                                      │
├─────────────────────────────────────────────────────────┤
│ Case B: 문서 있음 (PRD ✅ 또는 CLAUDE.md ✅)             │
│ → Mode 5: 검증 모드                                     │
│ → Phase 0.3으로 진행                                    │
├─────────────────────────────────────────────────────────┤
│ Case C: Hook만 없음 (PRD ✅, .claude/hooks ❌)           │
│ → Hook 시스템만 추가                                    │
│ → Phase 6으로 바로 이동                                 │
└─────────────────────────────────────────────────────────┘
```

### 0.3 검증 모드 (Case B)

```markdown
📋 **기존 문서 발견**

| 파일 | 상태 | 최종 수정 |
|-----|------|----------|
| PRD.md | ✅ 있음 | 2024-01-10 |
| CLAUDE.md | ✅ 있음 | 2024-01-05 |
| .claude/skills/ | ❌ 없음 | - |

어떻게 진행할까요?

1. **[검증]** - 기존 PRD vs 실제 코드 비교
   → 불일치 항목 발견 시 업데이트 제안

2. **[보강]** - 기존 문서 유지 + 스킬/Hook만 추가
   → PRD 수정 없이 프레임워크만 도입

3. **[리셋]** - 기존 문서 백업 후 새로 분석
   → 코드 기준 완전히 새로운 PRD 생성
```

### 0.4 검증 모드 상세 (선택 1)

```markdown
## PRD vs 코드 검증 결과

### 일치 항목 ✅
- 기술 스택: Next.js 14, Tailwind (PRD = 코드)
- 인증 방식: NextAuth (PRD = 코드)

### 불일치 항목 ⚠️
| PRD 내용 | 실제 코드 | 권장 |
|---------|----------|-----|
| ORM: Prisma | Drizzle 사용 중 | PRD 업데이트 |
| 페이지: 5개 | 8개 존재 | PRD에 추가 |
| 결제 기능 | 미구현 | 상태 표시 |

### 누락 항목 ❌
- PRD에 없는 기능: `/api/analytics`, `/dashboard/reports`
- 코드에 없는 기능: "알림 시스템" (PRD 3.4)

### 권장 액션
1. PRD.md 업데이트 (불일치 항목 반영)
2. 누락 기능 상태 표시 (구현됨/미구현)
3. 스킬 생성 (코드 패턴 기반)

[자동 업데이트] [수동 검토] [취소]
```

---

## Phase 1: 프로젝트 스캔

### 1.1 구조 분석
```
스캔 대상:
├── package.json → 의존성, 스크립트
├── tsconfig.json → TypeScript 설정
├── 설정 파일들 → 프레임워크 감지
│   ├── next.config.* → Next.js
│   ├── vite.config.* → Vite
│   ├── tailwind.config.* → Tailwind
│   ├── drizzle.config.* → Drizzle
│   └── prisma/ → Prisma
├── src/ 또는 app/ → 소스 구조
└── .env.example → 환경변수 목록
```

### 1.2 출력
```markdown
📊 **프로젝트 분석 결과**

**감지된 기술 스택:**
| 영역 | 기술 | 버전 | 확신도 |
|-----|------|-----|-------|
| 프레임워크 | Next.js | 14.x | ✅ 확실 |
| 스타일링 | Tailwind CSS | 3.x | ✅ 확실 |
| ORM | Drizzle | 0.29.x | ✅ 확실 |
| 인증 | NextAuth | - | ⚠️ 추정 |

**디렉토리 구조:**
├── app/ (App Router)
├── components/
├── lib/
└── db/

이 분석이 맞나요? [확인] [수정]
```

---

## Phase 2: 코드 패턴 분석

### 2.1 API 패턴 추출
```
스캔: app/api/**/route.ts

추출 항목:
- 인증 방식 (getServerSession? auth()? 커스텀?)
- 에러 처리 패턴
- 응답 형식
- 입력 검증 (Zod? 직접?)
```

### 2.2 컴포넌트 패턴 추출
```
스캔: components/**/*.tsx

추출 항목:
- export 방식 (named? default?)
- Props 정의 방식 (interface? type?)
- 스타일링 방식 (Tailwind? CSS Modules?)
- 상태 관리 (useState? Zustand? SWR?)
```

### 2.3 일관성 체크
```markdown
⚠️ **일관성 문제 발견**

| 패턴 | 파일 A | 파일 B | 권장 |
|-----|-------|-------|-----|
| export | named | default | named 통일 |
| Props | interface | type | interface 통일 |
| 인증 | getServerSession | auth() | 하나로 통일 |

이 문제들을 어떻게 처리할까요?
1. [현재 상태 유지] - PRD에 현재 패턴 그대로 기록
2. [점진적 통일] - 새 코드는 권장 패턴, 기존은 유지
3. [즉시 리팩토링] - 모든 코드 통일 (시간 소요)
```

### 2.4 품질 레벨 선택 (신규)

패턴이 들쭉날쭉할 때, 어떤 기준을 적용할지 선택:

```markdown
📊 **코드 패턴 분석 결과**

| 패턴 | 다수파 | 소수파 | 비율 |
|-----|-------|-------|-----|
| Export | named (45개) | default (30개) | 60:40 |
| Props | interface (50개) | type (25개) | 67:33 |
| 타입 안전 | 완전 (20개) | any 사용 (35개) | 36:64 |

⚠️ 일관된 기준을 찾기 어렵습니다.

**품질 레벨을 선택해주세요:**

┌─────────────────────────────────────────────────────────┐
│ **Level 1: 관대함** (현실 우선)                          │
├─────────────────────────────────────────────────────────┤
│ • 기존 패턴 그대로 유지                                   │
│ • 새 코드도 주변 코드와 일관되게                          │
│ • any 허용 (단, HOTFIX 표시)                            │
│ • 빠른 개발 속도, 낮은 진입 장벽                          │
│                                                         │
│ 적합: 레거시가 많은 프로젝트, 급한 일정                   │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ **Level 2: 균형** (권장)                                 │
├─────────────────────────────────────────────────────────┤
│ • 새 코드: 베스트 프랙티스 강제                          │
│ • 기존 코드: 수정 시에만 점진적 개선                      │
│ • any: 새 코드 금지, 기존 허용                           │
│ • 다수파 패턴을 표준으로 채택                             │
│                                                         │
│ 적합: 대부분의 프로젝트                                  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ **Level 3: 엄격함** (품질 우선)                          │
├─────────────────────────────────────────────────────────┤
│ • 베스트 프랙티스 전면 적용                              │
│ • 기존 코드도 리팩토링 대상                              │
│ • any 완전 금지                                         │
│ • 모든 패턴 통일 필수                                    │
│                                                         │
│ 적합: 신규 프로젝트, 시간 여유 있을 때                    │
└─────────────────────────────────────────────────────────┘

선택: [Level 1] [Level 2] [Level 3]
```

### 2.5 레벨별 스킬 생성 전략

```
Level 1 선택 시:
├── 스킬 체크리스트: 최소화 (필수 보안 규칙만)
├── 금지 사항: .env 커밋, API 키 하드코딩만
└── Hook: 경고만 표시, 차단 안 함

Level 2 선택 시:
├── 스킬 체크리스트: 표준 (다수파 패턴 기준)
├── 금지 사항: any(새 코드), 하드코딩, console.log
└── Hook: 체크리스트 표시, 권장 사항 알림

Level 3 선택 시:
├── 스킬 체크리스트: 전체 (베스트 프랙티스)
├── 금지 사항: 모든 규칙 적용
└── Hook: 엄격한 검증, 위반 시 경고
```

### 2.6 선택 결과 기록

```markdown
## .claude/config.json (생성됨)

{
  "quality_level": 2,
  "adopted_patterns": {
    "export": "named",
    "props": "interface",
    "styling": "tailwind"
  },
  "legacy_exceptions": [
    "src/legacy/*",
    "src/old-components/*"
  ],
  "created_at": "2024-01-15"
}
```

→ skill-enforcer.py가 이 설정 참조하여 레벨별 동작

---

## Phase 3: 규칙 위반 감지

### 3.1 스캔 항목
```
- any 타입 사용
- 하드코딩된 문자열 (사이트명, URL 등)
- console.log 존재
- 환경변수 하드코딩
- 200줄 초과 파일
```

### 3.2 출력
```markdown
🔍 **규칙 위반 현황**

**심각도: 높음** (즉시 수정 권장)
- `src/lib/api.ts:45` - any 타입 3회
- `src/config.ts:12` - API 키 하드코딩

**심각도: 중간** (점진적 수정)
- `src/components/Header.tsx:8` - 사이트명 하드코딩
- `src/pages/about.tsx:15` - 사업자번호 하드코딩

**심각도: 낮음** (선택적 수정)
- `src/utils/debug.ts` - console.log 10회 (개발용?)

어떻게 처리할까요?
1. [전체 리스트] - 모든 위반 사항 목록화
2. [자동 수정 가능 항목만] - 하드코딩 → config 이동
3. [나중에] - PRD에 기록 후 점진적 수정
```

---

## Phase 4: PRD 역생성

### 4.1 Q&A로 보완
```
코드 분석만으로 파악 불가능한 항목:

Q1. 이 프로젝트의 목적은 무엇인가요?
Q2. 주요 사용자는 누구인가요?
Q3. 핵심 기능 3가지는 무엇인가요?
Q4. 현재 개발 단계는? (MVP/베타/운영중)
Q5. 추가 예정 기능이 있나요?
```

### 4.2 PRD 생성
```markdown
# PRD: [프로젝트명] (역분석)

> ⚠️ 기존 코드베이스에서 역분석된 PRD입니다.
> 검토 후 수정이 필요할 수 있습니다.

## 1. 개요
[사용자 답변 기반]

## 2. 기술 스택
[Phase 1에서 감지된 스택]

## 3. 기능 명세

### 3.1 [기능 카테고리]
[코드 분석 + 사용자 답변 결합]

#### 세부 과제
- [ ] 기존 기능 A
  - **skills**: backend, database
  - **status**: ✅ 구현됨

- [ ] 기존 기능 B
  - **skills**: frontend
  - **status**: ✅ 구현됨

- [ ] 추가 예정 기능
  - **skills**: TBD
  - **status**: ⬜ 대기

## 4. 개선 필요 항목
[Phase 3에서 감지된 위반 사항]

---
⚠️ 이 PRD는 코드 역분석으로 생성됨. 검토 필요.
```

---

## Phase 5: 스킬 생성

### 5.1 기존 패턴 반영
```
코드에서 발견된 패턴 → 스킬에 반영

예시:
- API 인증 패턴: getServerSession + authOptions
  → backend 스킬에 이 패턴 명시

- 컴포넌트 패턴: interface Props + named export
  → frontend 스킬에 이 패턴 명시

- DB 쿼리 패턴: Drizzle + eq/and 조합
  → database 스킬에 이 패턴 명시
```

### 5.2 위반 사항 규칙화
```
발견된 위반 → 스킬 금지 사항에 추가

예시:
- 사이트명 하드코딩 발견
  → base-rules에 "siteConfig 사용 필수" 추가

- any 타입 남용 발견
  → 모든 스킬에 "any 금지" 강조
```

---

## Phase 6: Hook + CLAUDE.md 생성

### 6.1 Hook 설정
```
.claude/settings.json 생성
.claude/hooks/ 스크립트 복사
```

### 6.2 CLAUDE.md 생성
```markdown
# [프로젝트명]

> [한 문장 설명]
> ⚠️ 기존 프로젝트에 스킬 프레임워크 적용됨

## 기술 스택
[Phase 1 결과]

## 스킬 가이드
[생성된 스킬 목록]

## 레거시 주의사항
- 기존 코드 중 일부는 현재 스킬과 다른 패턴 사용
- 새 코드는 스킬 패턴 준수 필수
- 기존 코드 수정 시 점진적 통일 권장

## 개선 필요 항목
[Phase 3 위반 사항 요약]
```

---

## 완료 체크리스트

- [ ] 프로젝트 구조 스캔 완료
- [ ] 기술 스택 감지 및 사용자 확인
- [ ] 코드 패턴 분석 완료
- [ ] 규칙 위반 목록화
- [ ] PRD.md 역생성 완료
- [ ] 스킬 파일 생성 (기존 패턴 반영)
- [ ] CLAUDE.md 생성
- [ ] Hook 설정 완료
- [ ] 사용자에게 검토 요청

---

## 주의사항

1. **비파괴적 적용** - 기존 코드 수정 최소화
2. **점진적 통일** - 새 코드부터 스킬 적용
3. **현실적 기대** - 레거시 코드 즉시 완벽화 불가능
4. **문서화 우선** - 현재 상태 정확히 기록
